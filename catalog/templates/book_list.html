{% extends 'base.html' %}

{% block meta %}

{% endblock meta %}

{% block content %}

<div id="book-list">


</div>

<!-- Modal -->
<div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="successModalLabel">Success</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              Book borrowing was successful!
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
<!--End of Modal-->

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="errorModalLabel">Error</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
                Unsuccessful. The book has been borrowed.
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
<!--End of Modal-->

<script>
var allBooks = ""
var borrowButton;
async function getBooks() {
            return fetch("{% url 'main:get_books' %}").then((res) => res.json())
        }

async function refreshProducts() {
        const books = await getBooks()
        console.log(books)
        books.forEach((book) => {
        allBooks +=`
        <div>
        <p>${book.fields.title}</p>
        <div class="modal" tabindex="-1" role="dialog" id="myModal${book.pk}">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Borrow Book</h5>
              <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <!-- Your form goes here -->       
                <div class="form-group">
                <form id="form">
                        {% csrf_token %} 
                        <label for="date_ended">Pinjam sampai tanggal berapa sieh:</label>
                        <input type="date" onchange="changeValue();" class="form-control" id="date_ended" name="date_ended">
                </form>
                </div>
            </div>
            <div id="${book.pk}" class="modal-footer id-parent">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="submit" onclick="borrowBook(${book.pk});" class="btn btn-primary borrow" id="borrow-button" data-bs-dismiss="modal">Submit</button>
            </div>
          </div>
        </div>
        </div>

        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#myModal${book.pk}">Borrow Book</button>

        </div>
        `;
        
        })

        document.getElementById("book-list").innerHTML = allBooks
}

refreshProducts()

function borrowBook(itemId) {
        const date =  document.getElementById("date_ended")
        console.log(date.value)
        fetch("/myLibrary/borrow-books/" + itemId, {
        method: 'POST',
        body: new FormData(document.querySelector('#form'))
        })
        .then(response => {
        if (response.status === 201) {
            $('#successModal').modal('show');
        } else {
            $('#errorModal').modal('show');
        }
        });
}


function changeValue(){
        const dateInput = document.getElementById("date_ended");
        console.log(dateInput.value)
}
</script>

{% endblock content %}